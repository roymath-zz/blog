// generated from ~/git-dir/Blogging/Literate-Programming/blogging-in-asciidoc.nw

:imagesdir: Images
:figure-caption: Fig

## Motivation

Often, I find myself reading technical documentation in html.
For the longer ones, I prefer reading on the kindle.  An
e-ink display is much easier on your eyes. It's even better
when you step outside - the contrast only improves, affording you a
book-like experience. Compare this with tablets that
make you squint to see past the glare of their glossy screens.

This article is about how you can convert html documents, using the
linux command line, so they render nicely on the kindle.  The native
file format for the kindle is `.mobi`, and we'll use amazon's
*kindlegen* utility to convert files directly from `.html` to `.mobi`.


// [cols=3]
[cols="<.^,<.^,<.^"]
[frame="none", grid="none"]
|=======
a|image::html.png[width=300,title="kindle browser: web view"]
a|
### Reading on the kindle browser

The kindle comes with a built-in browser. It has been considered
_experimental_ for at least 10 years, but don't mind that - it does a
pretty good job of rendering html. In _article_ mode, it gives you a
nicer full-text view. This view is quite readable, and fairly suitable
for smaller articles. There are some quirks however, the main one
being that you have to remain online to be able to browse, since you
cannot save the content to the kindle.

a|image::article-mode.png[width=300,title="kindle browser: article mode"]

a|
### Reading in pdf

You can read PDFs directly on your Kindle - however given the smaller
screen size, the document tends to render somewhat smaller, and it’s
not ideal for reading.

a|image::pdf-landscape.png[width=300,title="pdf: landscape view"]
a|image::pdf-portrait.png[width=300,title="pdf: portrait view"]

a|image::mobi.png[width=300,title="Kindle Native (.mobi) view"]
2+a|
### Advantages of the `.mobi` format

Like HTML, `.mobi` files are flexible in how the page resizes
as you change the layout or font-size. You can make the font
quite large - great for tired eyes. The conversion to
`.mobi` from `.html` does a good job of keeping much of the 
html semantics - bold, italic, sections, paragraphs, etc..
so that the converted pages tend to look like they were
designed to be read on the kindle.


2+a|
### Smaller screen, keyhole view

Our craving for larger displays stems at least partly, from the fact
that we stare at big monitors all day and are used to seeing the
entirety of our pages when browsing.

The average kindle display is a relatively small 6 inches. I
bought an oasis for the slightly larger (7 inch) display, and it
does make a difference.

Most books and lengthy papers are meant to be read sequentially. As
you progress, you tend to develop a very focused "keyhole" view of
the content. Once you get used to this, the kindle's limited display
seems to be quite adequate, and offers a distraction free reading
experience.

a|image::keyhole-view.png[width=300]

2+a|
### Alternatives

There are nicer e-ink tablets with larger (10+ inch) displays; they will
cost you somewhere in the $500-$800 range. They tend to have
additional features geared toward marking up text, sketching, etc.

Your average kindle touch sells for about USD 100, and the oasis is
closer to about USD 300.
Amazon was offering a trade-in allowance on my
older kindle, so I took advantage of that, and paid closer to $200.
My primary need is reading, and the 7" Kindle
Oasis does nicely for that. 

a|image::other-tablets.png[width=300,title="Larger devices"]


3+a|
## Conversion

a|
### Kindlegen

*kindlegen* is available as a binary download from Amazon.
Once you've downloaded it, you can simply run it as shown.

Note: Sometimes, you'll want to get rid of characters
that don't display correctly, from your html before
running `kindlegen` - use the `iconv` utility for this.

2+a|
[source,shell]  
---- 
# convert non-ascii chars to closest ascii approximations.
iconv -f UTF8 -t US-ASCII//TRANSLIT index.html > index2.html

# this generates index2.mobi
kindlegen index2.html
---- 


2+a|
### Calibre and friends

I’ve used Calibre to do the conversions from html to `.mobi` format,
but I find it to be a rather heavy weight application for my
needs. Having said that, it’s a veritable swiss army knife for all
things related to reading and managing content on mobile devices, and
is well regarded.

You can use `pandoc` to convert HTML to a canonical pandoc format. From
there you can go to `.mobi` or `epub` format. However I think *kindlegen*
offers a more direct path from `.html` to `.mobi`.

a|image::calibre-connect.png[width=300, title="Calibre UI"]


3+a|
## USB detection and Copying


3+a|
### Copying files via USB

Once you’ve created your `.mobi` format, you can transfer the files over
to your Kindle. Basically this means

. plugging in your Kindle to a USB port
. Have your computer recognize the kindle as an external USB drive.
. copy files over
. eject (unmount) the kindle.


3+a|
### About usb cables

There are two kinds of USB cables

. A two wire cable that is designed to only charge your device
. A four wire cable that can provide both charge and data transfer to the USB device.

I was surprised about this. I had assumed all USB cables were the
same, and recall having been occasionally frustrated in the past when
some USB cables didn’t seem to work. Now I know.

Note: there is no easy way to look at the USB cable wire and tell if
it’s a two wire or four wire connector. I've seen writeups that suggest
that if the cable displays the USB logo, then it should allow for data
transfer as well as charge. YMMV.



2+a|
### Having your computer recognize the USB drive

You can tell that your Kindle has been recognized as a USB device when
it’s screen looks as shown here.

a|image::usb-drive-mode.png[width=300,title="kindle screen when recognized as usb drive"]

a|
You can tell from your computer by running `lsblk`, if the USB device
has been recognized. See below for the listing.

2+a|
.lsblk output - *sdb* shows up as a block device
[source,shell]  
---- 
[root@manjaro ~]# lsblk
NAME                      MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda                         8:0    0 931.5G  0 disk 
├─sda1                      8:1    0   260M  0 part /boot/efi
├─sda8                      8:8    0  97.7G  0 part 
│ ├─vg-home               254:4    0    34G  0 lvm  /home
│ ├─vg-cdroms             254:6    0    20G  0 lvm  /cdroms
├─sda9                      8:9    0    20G  0 part 
│ └─kvm--storage-machines 254:3    0    20G  0 lvm  /mnts/kvm-storage
├─sda10                     8:10   0  24.4G  0 part /
└─sda11                     8:11   0 279.8G  0 part 
  ├─vg-home               254:4    0    34G  0 lvm  /home
sdb                         8:16   1   6.2G  0 disk 
sr0                        11:0    1  1024M  0 rom  
---- 


3+a|
The last few lines of your system logs (`dmesg`) should also indicate whether
the USB device has been recognized. Mine looks as shown below.

3+a|
.dmesg output - notice USB is detected as *sdb* 
[source,shell]  
---- 
[root@manjaro ~]# dmesg \| tail
usb 1-2: Product: Internal Storage
usb 1-2: SerialNumber: G000WL04928401JC
...
usb-storage 1-2:1.0: USB Mass Storage device detected
...
scsi host9: usb-storage 1-2:1.0
scsi 9:0:0:0: Direct-Access     Kindle   Internal Storage 0401 PQ: 0 ANSI: 2
sd 9:0:0:0: Power-on or device reset occurred
sd 9:0:0:0: [sdb] Attached SCSI removable disk
sd 9:0:0:0: [sdb] 13051821 512-byte logical blocks: (6.68 GB/6.22 GiB)
sd 9:0:0:0: [sdb] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA
---- 


2+a|
### Mounting the USB device

You’ll want to mount the USB device in order to be able to transfer
files; follow the incantations shown here.

I've read that the `usbmount` program can be set up to automatically
mount devices. I haven’t had much luck with it.
`Gnome automount` is another possibility for auto mounting. I haven’t
much experience with this either.

a|
[source,shell]  
---- 
mkdir -p /mnts/sdb
mount /dev/sdb /mnts/sdb
ls /mnts/sdb/documents
----


a|
### Copying files over

The kindle will recognize any `.mobi` files copied over
and will show them in your library.

a|
[source,shell]  
---- 
cp myfile.mobi /mnts/sdb/documents/
----

a|image::kindle-library.png[width=300,title=".mobi files to kindle"]

a|
[source,shell]  
---- 
eject /dev/sdb
----

2+a|
### Ejecting the USB drive
 
Once you’ve transferred the file over to the device, you'll want to
eject it. If you unplug the cable prematurely, you may end up with a
partially copied file, and the kindle will complain that it can’t read
it.


|=======

